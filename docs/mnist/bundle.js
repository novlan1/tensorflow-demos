(()=>{"use strict";var e,t,r={257:()=>{const e=tf,t=tfvis,r=784,n=10,i=Math.floor(54166.66666666667),o=65e3-i;class a{constructor(){this.shuffledTrainIndex=0,this.shuffledTestIndex=0}async load(){const t=new Image,a=document.createElement("canvas"),s=a.getContext("2d"),c=new Promise(((e,n)=>{t.crossOrigin="",t.onload=()=>{t.width=t.naturalWidth,t.height=t.naturalHeight;const n=new ArrayBuffer(20384e4),i=5e3;a.width=t.width,a.height=i;for(let e=0;e<13;e++){const o=new Float32Array(n,e*r*i*4,392e4);s.drawImage(t,0,e*i,t.width,i,0,0,t.width,i);const c=s.getImageData(0,0,a.width,a.height);for(let e=0;e<c.data.length/4;e++)o[e]=c.data[4*e]/255}this.datasetImages=new Float32Array(n),e()},t.src="http://127.0.0.1:8080/mnist/mnist_images.png"})),d=fetch("http://127.0.0.1:8080/mnist/mnist_labels_uint8"),[l,u]=await Promise.all([c,d]);this.datasetLabels=new Uint8Array(await u.arrayBuffer()),this.trainIndices=e.util.createShuffledIndices(i),this.testIndices=e.util.createShuffledIndices(o),this.trainImages=this.datasetImages.slice(0,r*i),this.testImages=this.datasetImages.slice(r*i),this.trainLabels=this.datasetLabels.slice(0,n*i),this.testLabels=this.datasetLabels.slice(n*i)}nextTrainBatch(e){return this.nextBatch(e,[this.trainImages,this.trainLabels],(()=>(this.shuffledTrainIndex=(this.shuffledTrainIndex+1)%this.trainIndices.length,this.trainIndices[this.shuffledTrainIndex])))}nextTestBatch(e){return this.nextBatch(e,[this.testImages,this.testLabels],(()=>(this.shuffledTestIndex=(this.shuffledTestIndex+1)%this.testIndices.length,this.testIndices[this.shuffledTestIndex])))}nextBatch(t,i,o){const a=new Float32Array(t*r),s=new Uint8Array(t*n);for(let e=0;e<t;e++){const t=o(),c=i[0].slice(t*r,t*r+r);a.set(c,e*r);const d=i[1].slice(t*n,t*n+n);s.set(d,e*n)}return{xs:e.tensor2d(a,[t,r]),labels:e.tensor2d(s,[t,n])}}}window.onload=async()=>{const r=new a;await r.load();const n=r.nextTestBatch(20),i=t.visor().surface({name:"输入示例"});for(let t=0;t<20;t+=1){const r=e.tidy((()=>n.xs.slice([t,0],[1,784]).reshape([28,28,1]))),o=document.createElement("canvas");o.width=28,o.height=28,o.style="margin: 4px",await e.browser.toPixels(r,o),i.drawArea.appendChild(o)}const o=e.sequential();o.add(e.layers.conv2d({inputShape:[28,28,1],kernelSize:5,filters:8,strides:1,activation:"relu",kernelInitializer:"varianceScaling"})),o.add(e.layers.maxPool2d({poolSize:[2,2],strides:[2,2]})),o.add(e.layers.conv2d({kernelSize:5,filters:16,strides:1,activation:"relu",kernelInitializer:"varianceScaling"})),o.add(e.layers.maxPool2d({poolSize:[2,2],strides:[2,2]})),o.add(e.layers.flatten()),o.add(e.layers.dense({units:10,activation:"softmax",kernelInitializer:"varianceScaling"})),o.compile({loss:"categoricalCrossentropy",optimizer:e.train.adam(),metrics:["accuracy"]});const[s,c]=e.tidy((()=>{const e=r.nextTrainBatch(1e3);return[e.xs.reshape([1e3,28,28,1]),e.labels]})),[d,l]=e.tidy((()=>{const e=r.nextTestBatch(200);return[e.xs.reshape([200,28,28,1]),e.labels]}));await o.fit(s,c,{validationData:[d,l],batchSize:500,epochs:20,callbacks:t.show.fitCallbacks({name:"训练效果"},["loss","val_loss","acc","val_acc"],{callbacks:["onEpochEnd"]})});const u=document.querySelector("canvas");u.addEventListener("mousemove",(e=>{if(1===e.buttons){const t=u.getContext("2d");t.fillStyle="rgb(255,255,255)",t.fillRect(e.offsetX,e.offsetY,25,25)}})),window.clear=()=>{const e=u.getContext("2d");e.fillStyle="rgb(0,0,0)",e.fillRect(0,0,300,300)},clear(),window.predict=()=>{const t=e.tidy((()=>e.image.resizeBilinear(e.browser.fromPixels(u),[28,28],!0).slice([0,0,0],[28,28,1]).toFloat().div(255).reshape([1,28,28,1]))),r=o.predict(t).argMax(1);alert(`预测结果为 ${r.dataSync()[0]}`)}}}},n={};function i(e){if(n[e])return n[e].exports;var t=n[e]={exports:{}},o={id:e,module:t,factory:r[e],require:i};return i.i.forEach((function(e){e(o)})),t=o.module,o.factory.call(t.exports,t,t.exports,o.require),t.exports}i.m=r,i.c=n,i.i=[],i.hu=e=>e+"."+i.h()+".hot-update.js",i.hmrF=()=>"main."+i.h()+".hot-update.json",i.h=()=>"46328347d558627172a1",i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="js-ml-code:",i.l=(r,n,o)=>{if(e[r])e[r].push(n);else{var a,s;if(void 0!==o)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var l=c[d];if(l.getAttribute("src")==r||l.getAttribute("data-webpack")==t+o){a=l;break}}a||(s=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,i.nc&&a.setAttribute("nonce",i.nc),a.setAttribute("data-webpack",t+o),a.src=r),e[r]=[n];var u=(t,n)=>{a.onerror=a.onload=null,clearTimeout(f);var i=e[r];if(delete e[r],a.parentNode&&a.parentNode.removeChild(a),i&&i.forEach((e=>e(n))),t)return t(n)},f=setTimeout(u.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=u.bind(null,a.onerror),a.onload=u.bind(null,a.onload),s&&document.head.appendChild(a)}},(()=>{var e,t,r,n,o={},a=i.c,s=[],c=[],d="idle";function l(e){d=e;for(var t=0;t<c.length;t++)c[t].call(null,e)}function u(e){if(0===t.length)return e();var r=t;return t=[],Promise.all(r).then((function(){return u(e)}))}function f(e){if("idle"!==d)throw new Error("check() is only allowed in idle status");return l("check"),i.hmrM().then((function(n){if(!n)return l(m()?"ready":"idle"),null;l("prepare");var o=[];return t=[],r=[],Promise.all(Object.keys(i.hmrC).reduce((function(e,t){return i.hmrC[t](n.c,n.r,n.m,e,r,o),e}),[])).then((function(){return u((function(){return e?p(e):(l("ready"),o)}))}))}))}function h(e){return"ready"!==d?Promise.resolve().then((function(){throw new Error("apply() is only allowed in ready status")})):p(e)}function p(e){e=e||{},m();var t=r.map((function(t){return t(e)}));r=void 0;var i,o=t.map((function(e){return e.error})).filter(Boolean);if(o.length>0)return l("abort"),Promise.resolve().then((function(){throw o[0]}));l("dispose"),t.forEach((function(e){e.dispose&&e.dispose()})),l("apply");var a=function(e){i||(i=e)},s=[];return t.forEach((function(e){if(e.apply){var t=e.apply(a);if(t)for(var r=0;r<t.length;r++)s.push(t[r])}})),i?(l("fail"),Promise.resolve().then((function(){throw i}))):n?p(e).then((function(e){return s.forEach((function(t){e.indexOf(t)<0&&e.push(t)})),e})):(l("idle"),Promise.resolve(s))}function m(){if(n)return r||(r=[]),Object.keys(i.hmrI).forEach((function(e){n.forEach((function(t){i.hmrI[e](t,r)}))})),n=void 0,!0}i.hmrD=o,i.i.push((function(p){var m,v,g,y=p.module,w=function(r,n){var i=a[n];if(!i)return r;var o=function(t){if(i.hot.active){if(a[t]){var o=a[t].parents;-1===o.indexOf(n)&&o.push(n)}else s=[n],e=t;-1===i.children.indexOf(t)&&i.children.push(t)}else console.warn("[HMR] unexpected require("+t+") from disposed module "+n),s=[];return r(t)},c=function(e){return{configurable:!0,enumerable:!0,get:function(){return r[e]},set:function(t){r[e]=t}}};for(var f in r)Object.prototype.hasOwnProperty.call(r,f)&&"e"!==f&&Object.defineProperty(o,f,c(f));return o.e=function(e){return function(e){switch(d){case"ready":return l("prepare"),t.push(e),u((function(){l("ready")})),e;case"prepare":return t.push(e),e;default:return e}}(r.e(e))},o}(p.require,p.id);y.hot=(m=p.id,v=y,g={_acceptedDependencies:{},_declinedDependencies:{},_selfAccepted:!1,_selfDeclined:!1,_selfInvalidated:!1,_disposeHandlers:[],_main:e!==m,_requireSelf:function(){s=v.parents.slice(),e=m,i(m)},active:!0,accept:function(e,t){if(void 0===e)g._selfAccepted=!0;else if("function"==typeof e)g._selfAccepted=e;else if("object"==typeof e&&null!==e)for(var r=0;r<e.length;r++)g._acceptedDependencies[e[r]]=t||function(){};else g._acceptedDependencies[e]=t||function(){}},decline:function(e){if(void 0===e)g._selfDeclined=!0;else if("object"==typeof e&&null!==e)for(var t=0;t<e.length;t++)g._declinedDependencies[e[t]]=!0;else g._declinedDependencies[e]=!0},dispose:function(e){g._disposeHandlers.push(e)},addDisposeHandler:function(e){g._disposeHandlers.push(e)},removeDisposeHandler:function(e){var t=g._disposeHandlers.indexOf(e);t>=0&&g._disposeHandlers.splice(t,1)},invalidate:function(){switch(this._selfInvalidated=!0,d){case"idle":r=[],Object.keys(i.hmrI).forEach((function(e){i.hmrI[e](m,r)})),l("ready");break;case"ready":Object.keys(i.hmrI).forEach((function(e){i.hmrI[e](m,r)}));break;case"prepare":case"check":case"dispose":case"apply":(n=n||[]).push(m)}},check:f,apply:h,status:function(e){if(!e)return d;c.push(e)},addStatusHandler:function(e){c.push(e)},removeStatusHandler:function(e){var t=c.indexOf(e);t>=0&&c.splice(t,1)},data:o[m]},e=void 0,g),y.parents=s,y.children=[],s=[],p.require=w})),i.hmrC={},i.hmrI={}})(),(()=>{var e;i.g.importScripts&&(e=i.g.location+"");var t=i.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");r.length&&(e=r[r.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),i.p=e})(),(()=>{var e,t,r,n,o={179:0},a={};function s(e){return new Promise(((t,r)=>{a[e]=t;var n=i.p+i.hu(e),o=new Error;i.l(n,(t=>{if(a[e]){a[e]=void 0;var n=t&&("load"===t.type?"missing":t.type),i=t&&t.target&&t.target.src;o.message="Loading hot update chunk "+e+" failed.\n("+n+": "+i+")",o.name="ChunkLoadError",o.type=n,o.request=i,r(o)}}))}))}function c(a){function s(e){for(var t=[e],r={},n=t.map((function(e){return{chain:[e],id:e}}));n.length>0;){var o=n.pop(),a=o.id,s=o.chain,d=i.c[a];if(d&&(!d.hot._selfAccepted||d.hot._selfInvalidated)){if(d.hot._selfDeclined)return{type:"self-declined",chain:s,moduleId:a};if(d.hot._main)return{type:"unaccepted",chain:s,moduleId:a};for(var l=0;l<d.parents.length;l++){var u=d.parents[l],f=i.c[u];if(f){if(f.hot._declinedDependencies[a])return{type:"declined",chain:s.concat([u]),moduleId:a,parentId:u};-1===t.indexOf(u)&&(f.hot._acceptedDependencies[a]?(r[u]||(r[u]=[]),c(r[u],[a])):(delete r[u],t.push(u),n.push({chain:s.concat([u]),id:u})))}}}}return{type:"accepted",moduleId:e,outdatedModules:t,outdatedDependencies:r}}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];-1===e.indexOf(n)&&e.push(n)}}i.f&&delete i.f.jsonpHmr,e=void 0;var d={},l=[],u={},f=function(e){console.warn("[HMR] unexpected require("+e.id+") to disposed module")};for(var h in t)if(i.o(t,h)){var p,m=t[h],v=!1,g=!1,y=!1,w="";switch((p=m?s(h):{type:"disposed",moduleId:h}).chain&&(w="\nUpdate propagation: "+p.chain.join(" -> ")),p.type){case"self-declined":a.onDeclined&&a.onDeclined(p),a.ignoreDeclined||(v=new Error("Aborted because of self decline: "+p.moduleId+w));break;case"declined":a.onDeclined&&a.onDeclined(p),a.ignoreDeclined||(v=new Error("Aborted because of declined dependency: "+p.moduleId+" in "+p.parentId+w));break;case"unaccepted":a.onUnaccepted&&a.onUnaccepted(p),a.ignoreUnaccepted||(v=new Error("Aborted because "+h+" is not accepted"+w));break;case"accepted":a.onAccepted&&a.onAccepted(p),g=!0;break;case"disposed":a.onDisposed&&a.onDisposed(p),y=!0;break;default:throw new Error("Unexception type "+p.type)}if(v)return{error:v};if(g)for(h in u[h]=m,c(l,p.outdatedModules),p.outdatedDependencies)i.o(p.outdatedDependencies,h)&&(d[h]||(d[h]=[]),c(d[h],p.outdatedDependencies[h]));y&&(c(l,[p.moduleId]),u[h]=f)}t=void 0;for(var b,I=[],x=0;x<l.length;x++){var E=l[x];i.c[E]&&i.c[E].hot._selfAccepted&&u[E]!==f&&!i.c[E].hot._selfInvalidated&&I.push({module:E,require:i.c[E].hot._requireSelf,errorHandler:i.c[E].hot._selfAccepted})}return{dispose:function(){var e;r.forEach((function(e){delete o[e]})),r=void 0;for(var t,n=l.slice();n.length>0;){var a=n.pop(),s=i.c[a];if(s){var c={},u=s.hot._disposeHandlers;for(x=0;x<u.length;x++)u[x].call(null,c);for(i.hmrD[a]=c,s.hot.active=!1,delete i.c[a],delete d[a],x=0;x<s.children.length;x++){var f=i.c[s.children[x]];f&&(e=f.parents.indexOf(a))>=0&&f.parents.splice(e,1)}}}for(var h in d)if(i.o(d,h)&&(s=i.c[h]))for(b=d[h],x=0;x<b.length;x++)t=b[x],(e=s.children.indexOf(t))>=0&&s.children.splice(e,1)},apply:function(e){for(var t in u)i.o(u,t)&&(i.m[t]=u[t]);for(var r=0;r<n.length;r++)n[r](i);for(var o in d)if(i.o(d,o)){var s=i.c[o];if(s){b=d[o];for(var c=[],f=[],h=0;h<b.length;h++){var p=b[h],m=s.hot._acceptedDependencies[p];if(m){if(-1!==c.indexOf(m))continue;c.push(m),f.push(p)}}for(var v=0;v<c.length;v++)try{c[v].call(null,b)}catch(t){a.onErrored&&a.onErrored({type:"accept-errored",moduleId:o,dependencyId:f[v],error:t}),a.ignoreErrored||e(t)}}}for(var g=0;g<I.length;g++){var y=I[g],w=y.module;try{y.require(w)}catch(t){if("function"==typeof y.errorHandler)try{y.errorHandler(t)}catch(r){a.onErrored&&a.onErrored({type:"self-accept-error-handler-errored",moduleId:w,error:r,originalError:t}),a.ignoreErrored||e(r),e(t)}else a.onErrored&&a.onErrored({type:"self-accept-errored",moduleId:w,error:t}),a.ignoreErrored||e(t)}}return l}}}globalThis.webpackHotUpdatejs_ml_code=(e,r,o)=>{for(var s in r)i.o(r,s)&&(t[s]=r[s]);o&&n.push(o),a[e]&&(a[e](),a[e]=void 0)},i.hmrI.jsonp=function(e,o){t||(t={},n=[],r=[],o.push(c)),i.o(t,e)||(t[e]=i.m[e])},i.hmrC.jsonp=function(a,d,l,u,f,h){f.push(c),e={},r=d,t=l.reduce((function(e,t){return e[t]=!1,e}),{}),n=[],a.forEach((function(t){i.o(o,t)&&void 0!==o[t]&&(u.push(s(t)),e[t]=!0)})),i.f&&(i.f.jsonpHmr=function(t,r){e&&!i.o(e,t)&&i.o(o,t)&&void 0!==o[t]&&(r.push(s(t)),e[t]=!0)})},i.hmrM=()=>{if("undefined"==typeof fetch)throw new Error("No browser support: need fetch API");return fetch(i.p+i.hmrF()).then((e=>{if(404!==e.status){if(!e.ok)throw new Error("Failed to fetch update manifest "+e.statusText);return e.json()}}))}})(),i(257)})();